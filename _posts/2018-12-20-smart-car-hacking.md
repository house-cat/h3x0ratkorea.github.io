---
layout: post
title:  Smart Car Hacking
date:   2018-12-20 13:16:01 -0600
category : Hacking

---


-Kangsecu

###### 보편적인 해킹 시나리오

- 차량 내의 어플리케이션에 악성코드 감염
- 무선통신 취약점 및  Car canbus를 이용한 해킹
- 서비스 거부를 이용한 차량 오동작 

###### 전통적인 해킹과 다른 시나리오

- 차량 소유자의 핸드폰을 장악한 상황
- Telematics 디바이스의 핸드폰 번호를 알고 있는 상황 
- 차량에 가까이 혹은 차량 안에 위치할 수 있는 상황

이렇게 서술하긴 했으나 요새는 이러한 기법들 역시 주로 사용됨

###### Advanced Firmware Dump

- ASLR
- DEP
- SMEP
- CODE SIGNING

기존 방식의 펌웨어 덤프가 안 통하는 덤프가 존재

가장 대표적인 예시로 Code Protection이 걸린 임베디드칩은 하드웨어적으로 보호돼있기 때문에 read가 불가능하며 오직 erase 후 re-write만 가능 > 이런 경우에는 펌웨어를 추출하기 위해서 여러 가지 기법을 이용해야 한다. 

개발자들은 주로 지적재산권이 높은 코드나 리버싱에 특히 취약한 코드에 code protection을 걸어둠.

------

###### FIB(집속 이온 빔)

![kakaotalk_20181219_230714898](https://user-images.githubusercontent.com/36659181/50265195-d0a00e80-0461-11e9-9be2-231bd63bd534.jpg)



하드웨어적인 관점에서 봤을 땐, Code Protection이 걸린 칩에서 펌웨어를 추출할 때에는  FIB(Focused Ion Beam)라고 불리는 집속이온빔을 이용하여 나노 크기의 분석 및 조작이 가능하다. FIB는 매우 가늘게 집속한 이온 빔을 분석 대상에 표면에 주사해서 발생한 전자/이온을 검출하여 이를 분석하거나 가공이 가능하다. 

FIB 밀링 : 높은 가속전압을 이용하여 이온을 발생시키고, 전계를 이용해서 이온을 특정한 영역에 일정한 세기로 주사해서 원하는 회로로 가공하는 것을 의미한다.

FIB 식각/증착 기술을 이용하여 우리가 추출하지 못한 펌웨어의 회로를 수정할 수 있다. 또한 FIB밀링을 이용하여 특정 부분 오류분석이 가능한데 이를 이용하여 추출하려는 소스의 성분분석이 가능하다.



###### SEM(주사 전자 현미경)

![kakaotalk_20181219_230717091](https://user-images.githubusercontent.com/36659181/50265233-f9280880-0461-11e9-97d8-6653dc386808.jpg)

SEM은 주사 전자 현미경으로, 분석의 표본에 집중적인 전자빔을 줘서 반응을 분석하는 기기이다.

SEM을 이용한 플래쉬 메모리 캡처 :  전하를 줘서  바이너리셀이 반응시킬 때 어둡게 반응하면 0이고 어두우면 1처럼 값이 나타나는데, 이 값을 이용하여 바이너리 값을 수집 후 분석



###### Gliching

![kakaotalk_20181219_230713099](https://user-images.githubusercontent.com/36659181/50265208-dd246700-0461-11e9-8844-a7dc47a809b5.jpg)



위의 사진과 같이 Clock Gliching을 이용해서 조건문을 분기할 수 있다. 

하지만 이러한 방식으로 해커가 펌웨어 덤프를 따서 루트쉘을 따도 아직 Car CanBus에 접근하지 못했기 때문에 Entry Point이다. 하지만 그 루트쉘이 Car CanBus에 접근을 하는데 이용이 된다면 성공이라고 볼 수 있다.  그렇다면 그다음엔 우선 TCU를 해킹해서 Main mcu를 해킹하면 어떤 방식으로든 Sub mcu가 연결되어 있기 때문에 Sub mcu까지 장악이 가능해진다.

 그 후엔 Sub mcu를 업데이트하는 패킷을 가로챈 뒤, 이를 리버싱해서 해당 차량이 사용하는 Can포맷을 분석이 가능하다. 이는 여러 가지로 이용될 수 있는데, 악성 스크립트를 작성 후 다시 Sub mcu에 업로드 후에 RCE를 통해서 내가 원하는 악성 행위를 지시 및 실행 등의 해킹이 가능하다. 

악성 행위를 지시할 때, Can메세지는 크리티컬 파트에 있어서 접근하기 힘드니  차량 내에서 여러 작동을 했을 때 발생하는 메시지를 부르트포싱해서 패킷을 학습 후 조합이 가능하다. Can Message 모니터링 툴을 가동해서 각 동작별 발생하는 메시지를 분석후 전송하면된다.

예를 들어 차량에 엑셀레이터를 밟고 어떤 Can massage가 발생하는지 분석 후 다음에는 엑셀러레이터를 밟기 위해선 같은 명령어를 전송하면 된다. 하지만 이 방법은 차가 엑셀을 밟지 않을 때도 무수히 많은 패킷을 내보내기 때문에 어느 것이 엑셀 패킷인지 구분이 힘들다는 단점이 있다.

------

###### 마무리

자동차 해킹을 하기에 앞서서 iptime같은 디바이스를 구입해서 uart연결을 해보거나 펌웨어를 추출해서 SW적인 관점의 해킹 이외에도 HW의 관점에서 접근을 해보는 연습 등이 도움이 된다. 

기본적으로 FIB,SEB등을 다룰 수 있으면 좋겠지만 이 기기들은 평소에 접하기도 힘들고 가격도 매우 비싸니 잘 다뤄야 한다. 
